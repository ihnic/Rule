name: Update Rules

on:
  push:
    paths:
      - 'mosdns.txt'  # 当 mosdns.txt 变动时触发
  schedule:
    - cron: '0 0 * * *' # 每天 UTC 00:00
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process rules
        run: |
          python - <<EOF
          import os
          import subprocess
          from collections import defaultdict

          # 创建 mosdns 目录
          os.makedirs('mosdns', exist_ok=True)

          # 读取 mosdns.txt 并分组
          rules = defaultdict(list)
          with open('mosdns.txt', 'r') as f:
              for line in f:
                  name, url = line.strip().split(' ', 1)
                  rules[name].append(url)

          # 处理每个规则
          for name, urls in rules.items():
              output_file = f"mosdns/{name}.txt"
              unique_rules = set()
              
              # 下载并处理所有 URL 的内容
              for i, url in enumerate(urls):
                  temp_file = f"{name}_{i}.list"
                  subprocess.run(['curl', '-o', temp_file, url], check=True)
                  
                  with open(temp_file, 'r') as infile:
                      for line in infile:
                          if not line.strip().startswith('#'):
                              modified_line = line.replace('DOMAIN-SUFFIX,', 'full:') \
                                                .replace('DOMAIN,', 'domain:') \
                                                .replace('DOMAIN-KEYWORD,', 'keyword:') \
                                                .strip()
                              if modified_line:
                                  unique_rules.add(modified_line)
                  
                  os.remove(temp_file)
              
              # 写入去重后的规则
              with open(output_file, 'w') as outfile:
                  for rule_line in sorted(unique_rules):
                      outfile.write(rule_line + '\n')
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add mosdns/*.txt
          git commit -m "Update rules from mosdns.txt" || echo "No changes to commit"
          git push
