name: Update Rules

on:
  push:
    paths:
      - 'mosdns.txt'
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Process rules
        run: |
          python - <<EOF
          import os
          import subprocess
          from collections import OrderedDict, defaultdict

          # 创建 mosdns 目录
          os.makedirs('mosdns', exist_ok=True)

          # 读取 mosdns.txt 并按 name 分组，同时保持 URL 顺序
          rules_by_name = defaultdict(list)
          with open('mosdns.txt', 'r') as f:
              for line in f:
                  name, url = line.strip().split(' ', 1)
                  rules_by_name[name].append(url)

          # 处理每个 name 的规则
          for name, urls in rules_by_name.items():
              output_file = f"mosdns/{name}.txt"
              unique_rules = OrderedDict()  # 使用 OrderedDict 保持顺序并去重
              
              # 按顺序处理每个 URL
              for i, url in enumerate(urls):
                  temp_file = f"{name}_{i}.list"
                  subprocess.run(['curl', '-o', temp_file, url], check=True)
                  
                  with open(temp_file, 'r') as infile:
                      for line in infile:
                          if not line.strip().startswith('#'):
                              modified_line = line.replace('DOMAIN-SUFFIX,', 'full:') \
                                                .replace('DOMAIN,', 'domain:') \
                                                .replace('DOMAIN-KEYWORD,', 'keyword:') \
                                                .strip()
                              if modified_line:
                                  unique_rules[modified_line] = None
                  
                  os.remove(temp_file)
              
              # 写入去重后的规则到对应文件
              with open(output_file, 'w') as outfile:
                  for rule_line in unique_rules.keys():
                      outfile.write(rule_line + '\n')
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add mosdns/*.txt
          git commit -m "Update rules from mosdns.txt" || echo "No changes to commit"
          git push
